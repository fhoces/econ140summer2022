---
title: "Ec140 - Causality and Selection Bias"
author: "Fernando Hoces la Guardia"
date: "06/29/2022"
output: 
  xaringan::moon_reader:
    footer: "These slides available at https://fhoces.github.io/econ140summer2022/"
    css: [default, metropolis, metropolis-fonts] 
    lib_dir: libs
    nature:
      ratio: '16:9'
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
editor_options: 
  chunk_output_type: console
---

<style type="text/css">
.remark-slide-content {
    font-size: 30px;
    padding: 1em 1em 1em 1em;
}
</style>

```{r , include = F}
options(htmltools.dir.version = FALSE)
library(pacman)
p_load(ggthemes, viridis, knitr, extrafont, tidyverse, magrittr, latex2exp, 
       parallel, Ecdat, wooldridge, dslabs, ggforce, emo, png, grid, pander, 
       countdown, emoGG, haven)


options(htmltools.dir.version = FALSE)

# define vars
om = par("mar")
lowtop = c(om[1],om[2],0.1,om[4])

overwrite = FALSE


# Define colors
red_pink <- "#e64173"
met_slate <- "#23373b" # metropolis font color
# Notes directory
# Knitr options
opts_chunk$set(
  comment = "#>",
  fig.align = "center",
  fig.height = 7,
  fig.width = 10.5,
  #dpi = 300,
  #cache = T,
  message = FALSE,
  warning = FALSE,
  dev = "svg",
  cache = TRUE
  #fig.width = 11,
  #fig.height = 5
)

theme_simple <- theme_bw() + theme(
  axis.line = element_line(color = met_slate),
  panel.grid = element_blank(),
  rect = element_blank(),
  strip.text = element_blank(),
  text = element_text(family = "Fira Sans", color = met_slate, size = 14),
  axis.text.x = element_text(size = 12),
  axis.text.y = element_text(size = 12),
  axis.ticks = element_blank(),
  plot.title = element_blank(),
  legend.position = "none"
)
theme_empty <- theme_bw() + theme(
  line = element_blank(),
  rect = element_blank(),
  strip.text = element_blank(),
  axis.text = element_blank(),
  plot.title = element_blank(),
  axis.title = element_blank(),
  plot.margin = structure(c(0, 0, -1, -1), unit = "lines", valid.unit = 3L, class = "unit"),
  legend.position = "none"
)

# countdown style
countdown(
  color_border              = "#d90502",
  color_text                = "black",
  color_running_background  = "#d90502",
  color_running_text        = "white",
  color_finished_background = "white",
  color_finished_text       = "#d90502",
  color_finished_border     = "#d90502"
)



```



```{r Setup, include = F}
options(htmltools.dir.version = FALSE)
library(pacman)
p_load(ggthemes, viridis, knitr, extrafont, tidyverse, magrittr, latex2exp, parallel, Ecdat, wooldridge, dslabs, ggforce)
# Define colors
red_pink <- "#e64173"
met_slate <- "#23373b" # metropolis font color
# Notes directory
# Knitr options
opts_chunk$set(
  comment = "#>",
  fig.align = "center",
  fig.height = 7,
  fig.width = 10.5,
  #dpi = 300,
  #cache = T,
  warning = F,
  message = F
)  
theme_simple <- theme_bw() + theme(
  axis.line = element_line(color = met_slate),
  panel.grid = element_blank(),
  rect = element_blank(),
  strip.text = element_blank(),
  text = element_text(family = "Fira Sans", color = met_slate, size = 14),
  axis.text.x = element_text(size = 12),
  axis.text.y = element_text(size = 12),
  axis.ticks = element_blank(),
  plot.title = element_blank(),
  legend.position = "none"
)
theme_empty <- theme_bw() + theme(
  line = element_blank(),
  rect = element_blank(),
  strip.text = element_blank(),
  axis.text = element_blank(),
  plot.title = element_blank(),
  axis.title = element_blank(),
  plot.margin = structure(c(0, 0, -1, -1), unit = "lines", valid.unit = 3L, class = "unit"),
  legend.position = "none"
)

df_nhis <- read_dta("NHIS2009_clean.dta")

```

# Housekeeping 

- 


---

# Today's Lecture

- Motivation: Our First Causal Question in Real Life
      - Causality
      - Correlation v. Causation
      - Other things equal 

- Selection Bias


---
class: inverse, middle

# Potential Outcomes Framework 

---
# Causal Identification


## Goal 

Identify the effect of a .hi[treatment] on an .hi[outcome].

--

## Ideal data

Ideally, we could calculate the .hi[treatment effect] *for each individual* as

$$Y_{1,i} - Y_{0,i}$$ 

- $Y_{1,i}$ is the outcome for person $i$ when she receives the treatment.
- $Y_{0,i}$ is the outcome for person $i$ when she does not receive the treatment.
- Known as .pink[potential outcomes].

---
# Causal Identification

## Ideal data

.pull-left[
The *ideal* data for 10 people
```{R, ideal_data, echo = F}
set.seed(3)
ideal_df <- data.frame(
  i = 1:10,
  trt = rep(c(1, 0), each = 5),
  y1i = c(runif(10, 4, 10) %>% round(2)),
  y0i = c(runif(10, 0, 5) %>% round(2))
)
ideal_df
```
]

--

.pull-right[
Calculate the causal effect of treatment.
$$
\begin{align}
  \tau_i = y_{1,i} -  y_{0,i}
\end{align}
$$
for each individual $i$.
]
---
count: false
# Causal Identification

## Ideal data

.pull-left[
The *ideal* data for 10 people
```{R, ideal_data_trt, echo = F}
ideal_df %>% mutate(effect_i = y1i - y0i)
```
]

.pull-right[
Calculate the causal effect of treatment.
$$
\begin{align}
  \tau_i = y_{1,i} -  y_{0,i}
\end{align}
$$
for each individual $i$.
]
---
count: false
# Causal Identification

## Ideal data

.pull-left[
The *ideal* data for 10 people
```{R, ideal_data_trt2, echo = F}
ideal_df %>% mutate(effect_i = y1i - y0i)
```
]

.pull-right[
Calculate the causal effect of treatment.
$$
\begin{align}
  \tau_i = y_{1,i} -  y_{0,i}
\end{align}
$$
for each individual $i$.

The mean of $\tau_i$ is the<br>.hi[average treatment effect] (.pink[ATE]).

Thus, $\color{#e64173}{\overline{\tau} = `r transmute(ideal_df, effect_i = y1i - y0i) %>% unlist %>% mean %>% round(2)`}$
]

---
# Fundamental Problem of Econometrics

## Ideal comparison
$$
\begin{align}
  \tau_i = \color{#e64173}{y_{1,i}} &- \color{#9370DB}{y_{0,i}}
\end{align}
$$

Highlights the fundamental problem of econometrics.

--

## The problem

- If we observe $\color{#e64173}{y_{1,i}}$, then we cannot observe $\color{#9370DB}{y_{0,i}}$.

- If we observe $\color{#9370DB}{y_{0,i}}$, then we cannot observe $\color{#e64173}{y_{1,i}}$.

- Can only observe what actually happened; cannot observe the **counterfactual**.

---
# Fundamental Problem of Econometrics

A dataset that we can observe for 10 people looks something like
.pull-left[
```{R, ideal_data_obs, echo = F}
obs_df <- ideal_df
obs_df$y0i[1:5] <- NA
obs_df$y1i[6:10] <- NA
obs_df
```
]

--

.pull-right[
We can't observe $\color{#e64173}{y_{1,i}}$ and $\color{#9370DB}{y_{0,i}}$.

But, we do observe
- $\color{#e64173}{y_{1,i}}$ for $i$ in 1, 2, 3, 4, 5
- $\color{#9370DB}{y_{0,j}}$ for $j$ in 6, 7, 8, 9, 10

]

--

**Q:** How do we "fill in" the `NA`s and estimate $\overline{\tau}$?

---
# Estimating Causal Effects

**Notation:** $D_i$ is a binary indicator variable such that

- $\color{#e64173}{D_i=1}$ .pink[if individual] $\color{#e64173}{i}$ .pink[is treated].
- $\color{#9370DB}{D_i=0}$ .purple[if individual] $\color{#9370DB}{i}$ .purple[is not treated (*control* group).]

--

Then, rephrasing the previous slide,

- We only observe $\color{#e64173}{y_{1,i}}$ when $\color{#e64173}{D_{i}=1}$.
- We only observe $\color{#9370DB}{y_{0,i}}$ when $\color{#9370DB}{D_{i}=0}$.

--

**Q:** How can we estimate $\overline{\tau}$ using only $\left(\color{#e64173}{y_{1,i}|D_i=1}\right)$ and $\left(\color{#9370DB}{y_{0,i}|D_i=0}\right)$?

---
# Estimating Causal Effects

**Q:** How can we estimate $\overline{\tau}$ using only $\left(\color{#e64173}{y_{1,i}|D_i=1}\right)$ and $\left(\color{#9370DB}{y_{0,i}|D_i=0}\right)$?

--

**Idea:** What if we compare the groups' means? _I.e._,
$$
\begin{align}
  \color{#e64173}{\mathop{Avg}\left( y_i\mid D_i = 1 \right)} - \color{#9370DB}{\mathop{Avg}\left( y_i\mid D_i =0 \right)}
\end{align}
$$

--

**Q:** When does a simple difference-in-means provide information on the .hi-slate[causal effect] of the treatment?

--

**Q.sub[2.0]:** Is $\color{#e64173}{\mathop{Avg}\left( y_i\mid D_i = 1 \right)} - \color{#9370DB}{\mathop{Avg}\left( y_i\mid D_i =0 \right)}$ a *good* estimator for $\overline{\tau}$?

---
# Estimating Causal Effects

**Assumption:** Let $\tau_i = \tau$ for all $i$.

- The treatment effect is equal (constant) across all individuals $i$.

--

**Note:** We defined

$$
\begin{align}
  \tau_i = \tau = \color{#e64173}{y_{1,i}} - \color{#9370DB}{y_{0,i}}
\end{align}
$$

which implies

$$
\begin{align}
   \color{#e64173}{y_{1,i}} = \color{#9370DB}{y_{0,i}} + \tau
\end{align}
$$

---
class: clear-slide

**Q:** Is $\color{#e64173}{\mathop{Avg}\left( y_i\mid D_i = 1 \right)} - \color{#9370DB}{\mathop{Avg}\left( y_i\mid D_i =0 \right)}$ a *good* estimator for $\tau$?

--

Difference-in-means
--
<br> $\quad \color{#ffffff}{\Bigg|}=\color{#e64173}{\mathop{Avg}\left( y_i\mid D_i = 1 \right)} - \color{#9370DB}{\mathop{Avg}\left( y_i\mid D_i =0 \right)}$
--
<br> $\quad \color{#ffffff}{\Bigg|}=\color{#e64173}{\mathop{Avg}\left( y_{1,i}\mid D_i = 1 \right)} - \color{#9370DB}{\mathop{Avg}\left( y_{0,i}\mid D_i =0 \right)}$
--
<br> $\quad \color{#ffffff}{\Bigg|}=\color{#e64173}{\mathop{Avg}\left( \color{#000000}{\tau \: +} \: \color{#9370DB}{y_{0,i}} \mid D_i = 1 \right)} - \color{#9370DB}{\mathop{Avg}\left( y_{0,i}\mid D_i =0 \right)}$
--
<br> $\quad \color{#ffffff}{\Bigg|}=\tau + \color{#e64173}{\mathop{Avg}\left(\color{#9370DB}{y_{0,i}} \mid D_i = 1 \right)} - \color{#9370DB}{\mathop{Avg}\left( y_{0,i}\mid D_i =0 \right)}$
--
<br> $\quad \color{#ffffff}{\Bigg|}= \text{Average causal effect} + \color{#FD5F00}{\text{Selection bias}}$

--

Our proposed difference-in-means estimator gives us the sum of

1. $\tau$, the .hi-slate[causal, average treatment effect] that we want.
2. .hi-orange[Selection bias:] How much treatment and control groups differ, on average.

---
class: inverse, middle

# Randomized Control Trials 

---
# Selection Bias

**Problem:** Existence of selection bias precludes *all else equal* comparisons.

- To make valid comparisons that yield causal effects, we need to shut down the bias term.

--

**Potential solution:** Conduct an experiment.

- How? .hi[Random assignment of treatment].

- Hence the name, .hi[*randomized* control trial] (RCT).


---

# OTHER CLASS The Potential Outcomes Framework

Often called the **Rubin Causal Model** in honor of statistician **Donald Rubin** who generalised and formalized this model in the 1970's.

--

***Key idea***: Each individual can be exposed to **multiple alternative treatment states**.
  - smoking cigarrettes, smoking cigars or not smoking,
  - growing up in a poor vs a middle class neighborhood vs a rich neighborhood,
  - being in a small or a big class.
  
--

.pull-left[
For practicality, let this treatment variable $D_i$ be a binary variable:

$$
D_i = \begin{cases} 
                    1 \textrm{ if individual $i$ is treated} \\\\ 
                    0 \textrm{ if individual $i$ is not treated} 
      \end{cases}
$$
]

--

.pull-right[

***Treatment group***  
all the individuals such that $D_i = 1$.

***Control group***  
all the individuals such that $D_i = 0$.
]

---


# The Potential Outcomes Framework

* In this framework, each individual has two ***potential outcomes***, but only one ***observed outcome*** $Y_i$:
  
  - $Y_i^1$: *potential outcome if individual $i$ receives the treatment* $(D_i = 1)$,
  
  - $Y_i^0$: *potential outcome if individual $i$ does not receive the treatment* $(D_i = 0)$.

--

* In real life we only observe $Y_i$ which can be written as:

$$Y_i = D_i \times Y_i^1 + (1- D_i) \times Y_i^0$$

--

* ***Fundamental Problem of Causal Inference***: for any individual $i$, we only observe one of either potential outcomes [(Holland, 1986)](http://people.umass.edu/~stanek/pdffiles/causal-holland.pdf).

---

# The Potential Outcomes Framework

* The potential outcome that is not observed exists in principle, it is called the ***counterfactual outcome***.

--

Group | $Y_i^1$ | $Y_i^0$
--------|:---------:|:---------:
Treatment group $(D_i = 1)$ &nbsp; &nbsp; | &nbsp; &nbsp; Observable as $Y_i$ &nbsp; &nbsp; | Counterfactual
Control group $(D_i = 0)$ | Counterfactual | &nbsp; &nbsp; Observable as $Y_i$ &nbsp; &nbsp;

--

* From these we can define the ***individual treatment effect*** $\delta_i$:

$$ \delta_i = Y_i^1 - Y_i^0$$

* $\delta_i$ measures the **causal effect of the treatment $(D_i)$** on outcome $Y$ for individual $i$.

--

* Since the treatment effect *cannot* be observed at the individual level, we estimate population averages.

---

# Sidenote: Expectation and Conditional Expectation

Let's say you have a fair die and you roll it an infinite number of times. What is the average number rolled?

* If $X$ is a random variable containing the number rolled, we write:

$$
\mathop{\mathbb{E}}(X) = \frac{1}{6} \times 1 + \frac{1}{6} \times 2 + \frac{1}{6} \times 3 + \frac{1}{6} \times 4 + \frac{1}{6} \times 5 + \frac{1}{6} \times 6 = 3.5
$$

* The $\mathop{\mathbb{E}}(.)$ operator stands for **expectation** or *population mean*.

* The $\mathop{\mathbb{E}}(.)$ operator is linear, in other words, $\mathop{\mathbb{E}}(X+Y) = \mathop{\mathbb{E}}(X) + \mathop{\mathbb{E}}(Y)$ with $X$ and $Y$ being two random variables.

---

# Sidenote: Expectation and Conditional Expectation

Now, let's say you have two fair dice and you roll them an infinite number of times. What is the average sum of numbers rolled, conditional on one of them being always equal to 5?

* If $X$ is a random variable containing the number rolled of die 1 and $Y$ a random variable containing the number rolled of die 2, we write:

$$
\begin{align}
\mathop{\mathbb{E}}(X+Y|Y = 5) &= \mathop{\mathbb{E}}(X|Y = 5) + \mathop{\mathbb{E}}(Y|Y = 5) \\
&= \mathop{\mathbb{E}}(X) + 5 \\
&= 3.5 + 5 \\
&= 8.5
\end{align}
$$

* The $\mathop{\mathbb{E}}(.|D = x)$ operator stands for **conditional expectation**. It refers to the expectation over a subcategory of the entire population, namely people who satisfy the condition $D = x$.

---

name: ate

# Average Treatment Effect (ATE)

Broadest possible average effect:

\begin{align}
ATE &= \mathop{\mathbb{E}}(\delta_i) \\
    &= \mathop{\mathbb{E}}(Y_i^1 - Y_i^0) \\ 
    &= \mathop{\mathbb{E}}(Y_i^1) - \mathop{\mathbb{E}}(Y_i^0)
\end{align}
  
* The ATE simply measures the ***average of individual treatment effects over the whole population***.

([*Appendix:*](#attandatu) Average Treatment on the Treated and Average Treatment on the Untreated)

---

# Example: Small vs. Large Class

Potential outcomes for students of being in a small $(Y^1)$ or large class $(Y^0)$ on GPA (0-10):

.pull-left[
Student | &nbsp; &nbsp; $Y^1$ &nbsp; &nbsp; | &nbsp; &nbsp; $Y^0$ &nbsp; &nbsp; | &nbsp; &nbsp; $\delta$ &nbsp; &nbsp; 
-----------|:---------:|:---------:|:---------:|
1 | 5 | 2 | 3
2 | 6 | 4 | 2
3 | 3 | 6 | -3
4 | 5 | 4 | 1
5 | 10 | 8 | 2
6 | 2 | 4 | -2
7 | 5 | 2 | 3
8 | 6 | 4 | 2
9 | 2 | 9 | -7
10 | 8 | 2 | 6
Average | 5.2 | 4.5 | 0.7

]

--

.pull-right[

$$
\begin{align}
\color{#d90502}{\text{ATE}} &= \mathbb{E}(\delta) \\
&=\mathbb{E}(Y^1) - \mathbb{E}(Y^0) \\
&= 5.2 - 4.5 \\
&= 0.7
\end{align}
$$

$\rightarrow$ the ***average*** causal effect of being in small relative to large class on GPA is 0.7 points.

`r emo::ji("warning")` not all students benefited equally from the treatment!

]

---

# The Problem of Causal Inference

* In practice, we have the same **missing data problem** for computing the ATE as we did for $\delta_i$. Either $Y_i^1$ or $Y_i^0$ is missing for each $i$.

--

* From the data, we can compute the **S**imple **D**ifference in mean **O**utcomes (***SDO***) for both groups:

$$
\begin{align}
SDO &= \mathop{\mathbb{E}}(Y_i^1|D_i=1) - \mathop{\mathbb{E}}(Y_i^0|D_i=0) \\
&= \underbrace{\frac{1}{N_T}\sum_{i=1}^{N_T}(Y_i|D_i=1)}_{\text{average outcome of treatment group}} - \underbrace{\frac{1}{N_C}\sum_{i=1}^{N_C}(Y_i|D_i=0)}_{\text{average outcome of control group}}
\end{align}
$$ 

---

# Simple Difference in Mean Outcomes: With An Example

Now, imagine a benevolent and omniscient school director assigns students to the treatment that maximizes their GPA

--

Student | &nbsp; &nbsp; $Y^1$ &nbsp; &nbsp; | &nbsp; &nbsp; $Y^0$ &nbsp; &nbsp; | &nbsp; &nbsp; $\delta$ &nbsp; | &nbsp; &nbsp; &nbsp; $Y$ &nbsp; &nbsp; | &nbsp; &nbsp; $D$ &nbsp; &nbsp;
-----------|:---------:|:---------:|:---------:|:-----------:|:---------:|:---------:
1 | 5 | 2 | 3 |  | 
2 | 6 | 4 | 2 |  | 
3 | 3 | 6 | -3 |  | 
4 | 5 | 4 | 1 |  | 
5 | 10 | 8 | 2 |  | 
6 | 2 | 4 | -2 |  |
7 | 5 | 2 | 3 |  | 
8 | 6 | 4 | 2 |  | 
9 | 2 | 9 | -7 |  | 
10 | 8 | 2 | 6 |  | 

---

# Simple Difference in Mean Outcomes: With An Example

Now, imagine a benevolent and omniscient school director assigns students to the treatment that maximizes their GPA

Student | &nbsp; &nbsp; $Y^1$ &nbsp; &nbsp; | &nbsp; &nbsp; $Y^0$ &nbsp; &nbsp; | &nbsp; &nbsp; $\delta$ &nbsp; | &nbsp; &nbsp; &nbsp; $Y$ &nbsp; &nbsp; | &nbsp; &nbsp; $D$ &nbsp; &nbsp;
-----------|:---------:|:---------:|:---------:|:-----------:|:---------:|:---------:
1 | 5 | 2 | 3 | 5 | 1
2 | 6 | 4 | 2 | 6 | 1
3 | 3 | 6 | -3 | 6 | 0
4 | 5 | 4 | 1 | 5 | 1
5 | 10 | 8 | 2 | 10 | 1
6 | 2 | 4 | -2 | 4 | 0
7 | 5 | 2 | 3 | 5 | 1
8 | 6 | 4 | 2 | 6 | 1
9 | 2 | 9 | -7 | 9 | 0
10 | 8 | 2 | 6 | 8 | 1

---

# Simple Difference in Mean Outcomes: With An Example

.pull-left[
Student | &nbsp; &nbsp; $Y$ &nbsp; &nbsp; | &nbsp; &nbsp; $D$ &nbsp; &nbsp; | &nbsp; &nbsp; $\delta$&nbsp; &nbsp;
-----------|:---------:|:---------:|:---------:
1 | 5 | 1 | 3
2 | 6 | 1 | 2
3 | 6 | 0 | -3
4 | 5 | 1 | 1
5 | 10 | 1 | 2
6 | 4 | 0 | -2
7 | 5 | 1 | 3
8 | 6 | 1 | 2
9 | 9 | 0 | -7
10 | 8 | 1 | 6
Average |  |  | 0.7
]

.pull-right[
The simple difference in mean outcomes:

$$
\begin{align}
SDO &= \frac{5+6+5+10+5+6+8}{7} - \frac{6+4+9}{3} \\
&\approx 6.43 - 6.33 \approx 0.1
\end{align}
$$

* The SDO is much smaller than the ATE!

* Such a difference **will (almost always) fail to capture the causal treatment effect**

* Notice that this kind "naive" comparison is often done by journalists, politicians, badly trained scientists (but not you now! `r emo::ji("wink")`)
]

---

name: naive_comp

# Problems with Naive Comparisons

Let's rewrite the SDO to make the individual treatment effect $(\delta_i)$ appear in the equation. 

\begin{align}
  SDO &= \mathop{\mathbb{E}}(Y_i^1|D_i=1) - \mathop{\mathbb{E}}(Y_i^0|D_i=0) \\ &= \mathop{\mathbb{E}}(Y_i^0 + \delta_i | D_i = 1) - \mathop{\mathbb{E}}(Y_i^0 | D_i = 0)
\end{align}

--

For simplicity, suppose **treatment effect is constant** across people: for all $i, \delta_i = \delta$.

--

Then,

$$
  SDO = \delta + \mathop{\mathbb{E}}(Y_i^0 | D_i = 1) - \mathop{\mathbb{E}}(Y_i^0 | D_i = 0)
$$

And because $ATE = \mathop{\mathbb{E}}(\delta_i) = \mathop{\mathbb{E}}(\delta) = \delta$ (by assumption), we get: 


\begin{equation}
  SDO = ATE + \underbrace{\mathop{\mathbb{E}}(Y_i^0 | D_i = 1) - \mathop{\mathbb{E}}(Y_i^0 | D_i = 0)}_\text{Selection bias}
\end{equation}

([*Appendix*](#naive_comp_extended): when constant treatment assumption is relaxed another bias term appears.)

---

class:inverse

# Task 1: SDO, ATE and Randomization

`r countdown(minutes = 10, top = 0)`

Let's compute these various quantities and biases with data we generated ourselves.

```{r, echo = FALSE, eval = FALSE}
set.seed(1)
id = 1:10000
group = sample(c("treatment","control"), replace = T, size = 10000)
Y0 = sample(c(1:10), replace = T, size = 10000) + ifelse(group == "treatment",1,0)
delta = sample(c(1:3), replace = T, size = 10000) + 0.2*ifelse(group == "treatment",1,0)
cor(Y0, ifelse(group == "treatment",1,0))
cor(delta, ifelse(group == "treatment",1,0))
Y1 = Y0 + delta
set.seed(3)
group_random = sample(c("treatment","control"), replace = T, size = 10000)
cor(Y0, ifelse(group_random == "treatment",1,0))
cor(delta, ifelse(group_random == "treatment",1,0))

toy_data = data.frame(id, group, Y0, Y1)
toy_data <- toy_data %>%
  mutate(group_dummy = ifelse(group == "treatment", 1, 0)) %>%
  select(id, group, group_dummy, Y0, Y1)
toy_data_random = data.frame(id, group_random, Y0, Y1)
toy_data_random <- toy_data_random %>%
  mutate(group_random_dummy = ifelse(group_random == "treatment", 1, 0)) %>%
  select(id, group_random, group_random_dummy, Y0, Y1)

# fwrite(toy_data, here::here("../ScPoEconometrics/introduction/pierre_gustave/toy_data_2.csv"))
# fwrite(toy_data_random, here::here("../ScPoEconometrics/introduction/pierre_gustave/toy_data_random.csv"))
```

1. Load the data [here](https://www.dropbox.com/s/oqc3vq1m9eyp1d6/toy_data_2.csv?dl=1) using `read.csv`. The `group` variable corresponds to whether the individual has been treated or not, `Y0` to the potential outcome if the individual does not receive the treatment $(Y_i^0)$ while `Y1` to the potential outcome if the individual receives the treatment $(Y_i^1)$. Create a new variable containing the observed outcome $(Y_i)$ and the individual treatment effect $(\delta_i)$. Recall $Y_i = D_i \times Y_i^1 + (1 - D_i) \times Y_i^0$, $\delta_i = Y_i^1 - Y_i^0$.

1. Compute the ***ATE*** and the ***SDO***. Is there is any *bias*? Is it large in magnitude?

1. In this new [dataset](https://www.dropbox.com/s/0qfsonzz1t9gkxi/toy_data_random.csv?dl=1) we've randomly assigned the same individuals to the treatment and control groups. Compute the ***SDO under randomization***. Remember that you need to recompute $Y_i$ because the assignment is not the same anymore. If you got it right, the bias should be very close to 0. Why is it not exactly 0? 

1. *Optional*:  Compute the ***selection bias*** and the ***heterogeneous treatment effect bias*** and check that $SDO = ATE + \text{selection bias} + \text{heterogenous treatment effect bias}$




---

layout: false
class: title-slide-section-red, middle

# Appendix

---

layout: true

<div class="my-footer"><img src="../img/logo/ScPo-shield.png" style="height: 60px;"/></div> 

---

name: attandatu

# Average Treatment on the Treated and on the Untreated

Other ***conditional*** average treatment effects may be of interest:

.pull-left[
**A**verage **T**reatment on the **T**reated (***ATT***)

\begin{align}
 ATT &= \mathop{\mathbb{E}}(\delta_i | D_i = 1) \\
     &= \mathop{\mathbb{E}}(Y_i^1 - Y_i^0 | D_i = 1) \\
     &= \mathop{\mathbb{E}}(Y_i^1 | D_i = 1) - \mathop{\mathbb{E}}(Y_i^0 | D_i = 1)
\end{align}

The ATT measures the ***average treatment effect conditional on being in the treatment group***.

*Example:* the effect of participating in a training program (*treatment*) for those who participated (*treatment group*).
]

.pull-right[
**A**verage **T**reatment on the **U**ntreated (***ATU***)

\begin{align}
 ATU &= \mathop{\mathbb{E}}(\delta_i | D_i = 0) \\
     &= \mathop{\mathbb{E}}(Y_i^1 - Y_i^0 | D_i = 0) \\
     &= \mathop{\mathbb{E}}(Y_i^1 | D_i = 0) - \mathop{\mathbb{E}}(Y_i^0 | D_i = 0)
\end{align}

The ATU measures the ***average treatment effect conditional on being in the control group***.

*Example:* the effect of attending a private school (*treatment*) for students from a public school (*control group*).
]

*Note:* In the majority of cases, ATE $\neq$ ATT $\neq$ ATU! <span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span> [*back*](#ate)

---

name: naive_comp_extended

# Problems with Naive Comparisons

Let's now relax the assumption that the treatment effect is constant among all individuals.

After [some tedious calculations](https://mixtape.scunning.com/potential-outcomes.html#simple-difference-in-means-decomposition) that we skip, the SDO can now be decomposed as: 

\begin{align}
  SDO &= ATE + \underbrace{\mathop{\mathbb{E}}(Y_i^0 | D_i = 1) - \mathop{\mathbb{E}}(Y_i^0 | D_i = 0)}_\text{Selection bias} \\
  & \quad \quad  \quad \quad + \underbrace{(1-\pi)(ATT - ATU)}_\text{Heterogenous treatment effect bias}
\end{align}

where $1 - \pi$ denotes the share of people in the control group.

So there is a novel source of bias that comes from the potential ***heterogeneity in the individual treatment effect*** $\delta_i$.

* ***Selection bias***: those who attend university are likely to have higher baseline cognitive skills (regardless of whether they actually attend college).
* ***Heterogeneous treatment effect bias***: those who attend university may improve their cognitive skills more at university because they are more motivated. <span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span> [back](#naive_comp)



---

# Correlation vs Causation: Other Examples

> Why might the observed correlation between ***years of education*** and ***income*** not reflect the causal effect of education?

--

*Individuals who choose to get more education likely differ from those who don't: maybe they have higher innate ability, they enjoy schooling and are good at it* $\rightarrow$ ***self-selection***

--

> Why might the observed correlation between the ***employment rate*** and the ***minimum wage*** level not reflect the causal effect of the minimum wage?

--

*Policymakers may increase the minimum wage in times when the employment rate is high* $\rightarrow$ ***reverse causality / simultaneity***

--

> Why might the observed correlation between ***economic growth*** and ***financial development*** not reflect the causal effect of the financial sector?

--

*Again, maybe economic growth leads to financial development and not the other way around* $\rightarrow$ ***reverse causality / simultaneity***